#!/bin/bash
export password=MyCyber@rk01

export refresh_token=$(curl -s --user admin:$password https://127.0.0.1/authn/myorg/login) && echo $refresh_token
export response=$(curl -s -X POST https://127.0.0.1/authn/myorg/admin/authenticate -d ${refresh_token})
export access_token=$(echo -n $response | base64 | tr -d '\r\n') && echo $access_token

#load policy
source showSettings.sh && curl -s -H "Authorization: Token token=\"${access_token}\"" -X PUT -d "$(< policy.yml)" https://127.0.0.1/policies/myorg/policy/root | jq .

#append policy
source showSettings.sh && curl -s -H "Authorization: Token token=\"${access_token}\"" -X POST -d "$(< new_policy.yml)" https://127.0.0.1/policies/demo/policy/db | jq .
source showSettings.sh && curl -s -H "Authorization: Token token=\"${access_token}\"" -X POST -d "$(< next_policy.yml)" https://127.0.0.1/policies/demo/policy/db | jq .

#add a secret
source showSettings.sh && curl -s -H "Authorization: Token token=\"${access_token}\"" -X POST --data "c3c60d3f266074" https://127.0.0.1/secrets/demo/variable/db%2Fpassword

#retrieve a secret
source showSettings.sh && curl -s -H "Authorization: Token token=\"${access_token}\"" https://127.0.0.1/secrets/demo/variable/db%2Fpassword
